This is a small program that you can install on EC2 servers in order to enhance the security of the EC2 metadata server.

The metadata server is used to provide temporary security credentials to the IAM role associated with an EC2 instance. The server does not have any security protections built-in, and you can find [numerous](https://blog.christophetd.fr/abusing-aws-metadata-service-using-ssrf-vulnerabilities/) [examples](http://flaws.cloud/) [online](https://news.ycombinator.com/item?id=12670316) that show how this can be exploited.

Google Compute Engine, on the other hand, [requires a special header](https://cloud.google.com/compute/docs/storing-retrieving-metadata#querying) to be present (`Metadata-Flavor: Google`). This might seems like a small thing, but it is extremely effective. [Here is a good comparison of how the different cloud metadata services behave.](https://ahmet.im/blog/comparison-of-instance-metadata-services/)

There is [a Netflix blog post](https://medium.com/netflix-techblog/netflix-information-security-preventing-credential-compromise-in-aws-41b112c15179) on the subject, and it appears that they are working with AWS to add protections based on the User-Agent header instead (the details on how and when this will be available for everyone is unclear). The benefit of checking the User-Agent is that all SDKs should continue to just work (if you use `curl` or other libraries, you will have to update your code). I decided to support this behavior since it greatly simplifies rollout of this program since most applications won't require any modification.

The program acts as a reverse proxy, run by a special user (or root, if you prefer), and relies on an iptables rule to redirect all traffic destined for 169.254.169.254 through this proxy. The program blocks any request with a User-Agent that does not start with one of the following prefixes:

```
aws-chalice/
aws-cli/
aws-sdk-
Boto3/
Botocore/
```

In addition to whitelisting User-Agent prefixes, the program also allows requests that use the header `Metadata-Flavor: Amazon`. This is easy to add to programs such as curl.

# Install

The reverse proxy runs on port 16925 by default (you can use the `PORT` environment variable to change this), and listens only on the loopback interface.

## iptables rule

This creates a new user whose only purpose is to run the reverse proxy. Requests to 169.254.169.254 from any other user will be redirected to the proxy.

You can use root instead, but that is a bad idea if security bugs are found in _this_ program, and it would also exempt root from this protection.

```
$ sudo useradd --system ec2-metadata
$ sudo iptables -t nat -A OUTPUT -d 169.254.169.254 -p tcp -m owner \! --uid-owner ec2-metadata -j REDIRECT --to-port 16925
```

Then run the program as the special user:

```
$ sudo -u ec2-metadata ec2-metadata-filter
```

To persist your iptables rule, you can do something like the following:

```
$ sudo su
# iptables-save > /etc/iptables.rules
# cat << 'EOF' > /etc/network/if-pre-up.d/iptables
#!/bin/sh
iptables-restore /etc/iptables.rules
exit 0
EOF
chmod +x /etc/network/if-pre-up.d/iptables
```

The file `/etc/iptables.rules` should look something like the following:
```
# Generated by iptables-save v1.6.1
*nat
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
-A OUTPUT -d 169.254.169.254/32 -p tcp -m owner ! --uid-owner 999 -j REDIRECT --to-ports 16925
COMMIT
```

## Validate

Ensure that it is working properly!

Perform a request with the aws-cli (_without_ any local credentials present!):

```
$ aws sts get-caller-identity
```

In the other terminal, you should see the following:

```
Proxying request to /latest/meta-data/iam/security-credentials/ from User-Agent: aws-cli/1.15.71 Python/3.5.2 Linux/4.15.0-43-generic botocore/1.10.70
```

That means that the request was received by the program which then forwarded it after checking the User-Agent header. Now try with curl:

```
$ curl -i http://169.254.169.254/latest/meta-data/iam/security-credentials/
HTTP/1.1 400 Bad Request
```

The request was blocked, great!

Now try adding the `Metadata-Flavor: Amazon` header:

```
$ curl -i -H 'Metadata-Flavor: Amazon' http://169.254.169.254/latest/meta-data/iam/security-credentials/
HTTP/1.1 200 OK
```

That worked!

# Troubleshooting

Print your iptables rules by running `sudo iptables-save`. Does it contain the nat rule to redirect traffic destined for 169.254.169.254?

If you see the error `http: proxy error: context canceled`, that means that the program is having problems forwarding the request to the real metadata server. Are you running on an EC2 machine?

If you see hundreds of lines that eventually end with `http: proxy error: dial tcp 169.254.169.254:80: socket: too many open files`, that means that the program is also affected by the iptables rule. Are you running the program as the special user?

Elastic Beanstalk issue requests to the metadata server using `curl`, so it will not work out of the box. This requires more research.
